<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>refat's chatbot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css?family=Inter:400,500,600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --primary: #4CAF50;
      --accent: #FFC107;
      --bg: #f0f2f5;
      --glass: rgba(255,255,255,0.25);
      --text-dark: #111;
      --text-light: #fff;
      --radius: 1rem;
      --transition: 0.3s ease;
    }
    body.dark {
      --bg: #1f1f1f;
      --glass: rgba(32,33,36,0.5);
      --text-dark: #eee;
      --text-light: #ddd;
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family:'Inter',sans-serif;
      background:var(--bg);
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:2rem 1rem;
      min-height:100vh;
      transition:background var(--transition);
    }
    h1 {
      color:var(--primary);
      margin-bottom:1rem;
      font-size:2rem;
      text-align:center;
    }
    .toggle-theme {
      position:absolute; top:1rem; right:1rem;
      background:var(--accent); border:none; border-radius:50%;
      width:2rem; height:2rem; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      color:var(--text-dark); transition:transform var(--transition);
    }
    .toggle-theme:hover { transform:scale(1.1); }
    .chat-container {
      background:var(--glass);
      backdrop-filter:blur(10px);
      border-radius:var(--radius);
      width:100%; max-width:480px;
      display:flex; flex-direction:column;
      box-shadow:0 8px 32px rgba(0,0,0,0.1);
      border:1px solid rgba(255,255,255,0.3);
      overflow:hidden;
    }
    .file-upload {
      display:flex; align-items:center;
      padding:1rem; border-bottom:1px solid rgba(255,255,255,0.3);
      gap:0.5rem;
    }
    .file-upload input { display:none; }
    .file-upload label {
      background:var(--primary); color:var(--text-light);
      padding:0.5rem 1rem; border-radius:0.5rem;
      cursor:pointer; font-weight:500;
      transition:background var(--transition);
    }
    .file-upload label:hover { background:#43A047; }
    .file-name {
      flex:1; color:var(--text-dark);
      font-size:0.9rem; overflow:hidden;
      text-overflow:ellipsis; white-space:nowrap;
    }
    .chat-window {
      flex:1; padding:1rem; overflow-y:auto;
      display:flex; flex-direction:column; gap:0.75rem;
    }
    .message {
      max-width:75%; padding:0.75rem 1rem;
      border-radius:var(--radius); animation:fadeIn 0.3s;
    }
    .message.user {
      align-self:flex-end; background:var(--primary);
      color:var(--text-light); border-bottom-right-radius:0.25rem;
    }
    .message.ai {
      align-self:flex-start; background:var(--accent);
      color:var(--text-dark); border-bottom-left-radius:0.25rem;
    }
    @keyframes fadeIn {
      from { opacity:0; transform:translateY(10px); }
      to { opacity:1; transform:translateY(0); }
    }
    .input-row {
      display:flex; gap:0.5rem;
      padding:1rem; border-top:1px solid rgba(255,255,255,0.3);
      background:var(--glass);
    }
    .input-row input {
      flex:1; padding:0.75rem 1rem; border:none;
      border-radius:0.5rem; outline:none; font-size:1rem;
      transition:box-shadow var(--transition);
    }
    .input-row input:focus {
      box-shadow:0 0 0 3px rgba(76,175,80,0.3);
    }
    .send-btn {
      background:var(--primary); border:none;
      padding:0 1.2rem; border-radius:0.5rem;
      color:var(--text-light); font-weight:600;
      cursor:pointer; transition:background var(--transition) transform var(--transition);
    }
    .send-btn:hover {
      background:#43A047; transform:translateY(-2px);
    }
    .chat-window::-webkit-scrollbar { width:6px; }
    .chat-window::-webkit-scrollbar-thumb { background:rgba(0,0,0,0.2); border-radius:3px; }
    .chat-window::-webkit-scrollbar-track { background:transparent; }
  </style>
</head>
<body>
  <button class="toggle-theme" title="Toggle light/dark">ðŸŒ“</button>
  <h1>Chat with bots</h1>
  <div class="chat-container">
    <div class="file-upload">
      <label for="fileInput">ðŸ“Ž Upload</label>
      <input type="file" id="fileInput" accept=".txt,.png,.jpg,.jpeg,.webp,.gif" />
      <span class="file-name" id="fileName">No file chosen</span>
    </div>
    <div class="chat-window" id="chatWindow"></div>
    <form id="chatForm" class="input-row" autocomplete="off">
      <input id="userInput" type="text" placeholder="Type your messageâ€¦" />
      <button type="submit" class="send-btn">Send</button>
    </form>
  </div>

  <script>
    const KEY = "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";
    document.querySelector('.toggle-theme').onclick = () => document.body.classList.toggle('dark');

    const systemMessages = [{ role:"system", content:"You are a helpful AI assistant." }];
    const chatHistory = [];
    let fileContent = "", imageData = "", fileName = "";

    const fileInput = document.getElementById("fileInput");
    const fileNameSpan = document.getElementById("fileName");
    const chatWindow = document.getElementById("chatWindow");
    const chatForm = document.getElementById("chatForm");
    const userInput = document.getElementById("userInput");

    fileInput.addEventListener("change", async e => {
      const f = e.target.files[0];
      if (!f) return;
      fileName = f.name;
      fileNameSpan.textContent = fileName;
      fileContent = ""; imageData = "";

      if (f.type.startsWith("image/")) {
        const r = new FileReader();
        r.onload = () => { imageData = r.result; fileNameSpan.style.color="#4CAF50"; setTimeout(()=>fileNameSpan.style.color="",2000) };
        r.readAsDataURL(f);
      } else if (f.type==="text/plain") {
        const t = await f.text();
        fileContent = t.slice(0,12000);
        fileNameSpan.style.color="#4CAF50";
        setTimeout(()=>fileNameSpan.style.color="",2000);
      } else {
        fileNameSpan.textContent="Unsupported";
      }
    });

    function addMessage(role,txt){
      const d=document.createElement("div");
      d.className="message "+role;
      d.textContent=txt;
      chatWindow.appendChild(d);
      chatWindow.scrollTop=chatWindow.scrollHeight;
    }

    chatForm.addEventListener("submit",async e=>{
      e.preventDefault();
      const userTxt=userInput.value.trim();
      if (!userTxt && !imageData) return;

      // 1) show user
      addMessage("user", userTxt||"[Image]");

      // 2) build content string
      let prompt = userTxt;
      if (imageData) {
        prompt += "\n\n[Image Attached as Base64 Data URL]\n"+imageData;
      }
      if (fileContent) {
        prompt = `[File: ${fileName}]\n${fileContent}\n\nUser: `+prompt;
      }

      // 3) assemble messages array
      const msgs = [...systemMessages, ...chatHistory, { role:"user", content: prompt }];

      // 4) placeholder
      addMessage("ai","...");

      // 5) call API
      try {
        const res = await fetch("https://api.perplexity.ai/chat/completions", {
          method:"POST",
          headers:{
            "Authorization":`Bearer ${KEY}`,
            "Content-Type":"application/json",
            "accept":"application/json"
          },
          body: JSON.stringify({
            model:"sonar-pro",
            messages: msgs,
            max_tokens:1024,
            temperature:0.7
          })
        });
        const j = await res.json();
        chatWindow.removeChild(chatWindow.lastChild);

        const aiTxt = j.choices?.[0]?.message?.content?.trim();
        if (aiTxt) {
          addMessage("ai", aiTxt);
          chatHistory.push({ role:"user", content:prompt });
          chatHistory.push({ role:"assistant", content:aiTxt });
        } else {
          addMessage("ai","API Error: "+(j.error?.message||JSON.stringify(j)));
        }
      } catch(err) {
        chatWindow.removeChild(chatWindow.lastChild);
        addMessage("ai","Network error or invalid API key.");
      }

      // reset
      userInput.value="";
      fileContent=""; imageData="";
      fileNameSpan.textContent="No file chosen";
      fileInput.value="";
    });
  </script>
</body>
</html>
